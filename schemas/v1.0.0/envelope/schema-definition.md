# Arturo Message Envelope v1.0.0

## Overview

| Property | Value |
|----------|-------|
| Version | v1.0.0 |
| Format | JSON |
| Status | Active |

Every message in the Arturo system wraps its payload in this envelope. The envelope provides message identity, routing, correlation tracking, and source identification. All five message types share this structure.

## JSON Schema Definition

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://github.com/holla2040/arturo/schemas/v1.0.0/envelope.json",
  "title": "Arturo Message Envelope",
  "description": "Standard message envelope for Arturo Protocol v1.0.0.",
  "type": "object",
  "required": ["envelope", "payload"],
  "additionalProperties": false,
  "properties": {
    "envelope": {
      "type": "object",
      "description": "Message metadata and routing information.",
      "required": ["id", "timestamp", "source", "schema_version", "type"],
      "additionalProperties": false,
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique message identifier. UUIDv4 format.",
          "pattern": "^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$"
        },
        "timestamp": {
          "type": "string",
          "format": "date-time",
          "description": "UTC timestamp in RFC3339 format with millisecond precision."
        },
        "source": {
          "type": "object",
          "description": "Identifies who sent this message.",
          "required": ["service", "instance", "version"],
          "additionalProperties": false,
          "properties": {
            "service": {
              "type": "string",
              "description": "Service name.",
              "pattern": "^[a-z][a-z0-9_]*$",
              "minLength": 1,
              "maxLength": 64
            },
            "instance": {
              "type": "string",
              "description": "Instance identifier.",
              "pattern": "^[a-z0-9][a-z0-9_-]*$",
              "minLength": 1,
              "maxLength": 64
            },
            "version": {
              "type": "string",
              "description": "Software/firmware version. Semver format.",
              "pattern": "^[0-9]+\\.[0-9]+\\.[0-9]+$"
            }
          }
        },
        "schema_version": {
          "type": "string",
          "description": "Protocol version.",
          "const": "v1.0.0"
        },
        "type": {
          "type": "string",
          "description": "Message type in dot notation.",
          "enum": [
            "device.command.request",
            "device.command.response",
            "service.heartbeat",
            "system.emergency_stop",
            "system.ota.request"
          ]
        },
        "correlation_id": {
          "type": "string",
          "description": "Links a request to its response.",
          "pattern": "^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$"
        },
        "reply_to": {
          "type": "string",
          "description": "Redis Stream name where the response should be sent.",
          "pattern": "^[a-z0-9][a-z0-9_:/-]*$"
        }
      }
    },
    "payload": {
      "type": "object",
      "description": "Message-type-specific data. Schema depends on envelope.type."
    }
  }
}
```

## Field Descriptions

### Envelope Fields

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `id` | string | Yes | UUIDv4 unique message identifier. Generated by the sender. |
| `timestamp` | string | Yes | UTC timestamp in RFC3339 format with millisecond precision (e.g., `2026-02-17T12:00:00.000Z`). |
| `source` | object | Yes | Identifies the sender. See Source Fields below. |
| `schema_version` | string | Yes | Always `"v1.0.0"` for this protocol version. |
| `type` | string | Yes | Message type in dot notation. Determines the payload schema. |
| `correlation_id` | string | Conditional | UUIDv4 linking request to response. Required for `device.command.request` and `device.command.response`. |
| `reply_to` | string | Conditional | Redis Stream name for the response. Required for `device.command.request`. |

### Source Fields

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `service` | string | Yes | Service name. Lowercase with underscores (e.g., `esp32_tcp_bridge`, `controller`). |
| `instance` | string | Yes | Instance identifier. Lowercase with hyphens (e.g., `dmm-station-01`, `ctrl-01`). |
| `version` | string | Yes | Semver software/firmware version (e.g., `1.0.0`). |

## Correlation ID Usage

The `correlation_id` field links request-response pairs across Redis Streams.

**Flow:**
1. Controller generates a UUIDv4 `correlation_id` and includes it in `device.command.request`
2. Controller also sets `reply_to` to its response stream (e.g., `responses:controller:ctrl-01`)
3. Station echoes the same `correlation_id` in `device.command.response`
4. Station publishes the response to the `reply_to` stream
5. Controller matches the response to the original request by `correlation_id`

**Required by message type:**

| Message Type | `correlation_id` | `reply_to` |
|-------------|-------------------|------------|
| `device.command.request` | Required | Required |
| `device.command.response` | Required (echo from request) | Not used |
| `service.heartbeat` | Not used | Not used |
| `system.emergency_stop` | Not used | Not used |
| `system.ota.request` | Required | Required |

## Service Names

Known service names used in `source.service`:

| Service Name | Description |
|-------------|-------------|
| `controller` | Go controller process |
| `esp32_tcp_bridge` | Station bridging TCP/SCPI instruments |
| `esp32_serial_bridge` | Station bridging serial instruments |
| `esp32_relay_controller` | Station controlling relays |
| `esp32_estop` | Emergency stop station |
| `arturo_monitor` | Debugging/monitoring tool |

## Implementation Details

### Controller (Go)

```go
envelope := map[string]interface{}{
    "id":             uuid.New().String(),
    "timestamp":      time.Now().UTC().Format("2006-01-02T15:04:05.000Z"),
    "source": map[string]interface{}{
        "service":  "controller",
        "instance": "ctrl-01",
        "version":  "1.0.0",
    },
    "schema_version": "v1.0.0",
    "type":           "device.command.request",
    "correlation_id": uuid.New().String(),
    "reply_to":       "responses:controller:ctrl-01",
}
```

### Station Firmware (ArduinoJson)

```cpp
StaticJsonDocument<512> doc;
JsonObject envelope = doc.createNestedObject("envelope");
envelope["id"] = generateUUID();
envelope["timestamp"] = getISO8601Timestamp();
JsonObject source = envelope.createNestedObject("source");
source["service"] = "esp32_tcp_bridge";
source["instance"] = INSTANCE_ID;
source["version"] = FIRMWARE_VERSION;
envelope["schema_version"] = "v1.0.0";
envelope["type"] = "device.command.response";
envelope["correlation_id"] = request_correlation_id;  // echo from request
```

## Version History

### v1.0.0 (Current)
- Initial envelope definition
- Five message types defined
- UUIDv4 for message IDs and correlation IDs
- RFC3339 timestamps with millisecond precision
- Source identification with service, instance, and version
